BizQQWPA.define("wpa.visitor","lang.browser,util.log,util.speedReport,util.getJSONP,util.domain,util.pubSub,wpa.filter,wpa.ta,wpa.invite,wpa.wpaMgr,wpa.ta,wpa.kfuin",function(require){var invite=require("invite"),domain=require("domain"),filter=require("filter"),getJSONP=require("getJSONP"),pubSub=require("pubSub"),log=require("log"),speedReport=require("speedReport"),ta=require("ta"),kfuinCahe=require("kfuin"),browser=require("browser");var CRM_BLOCK_ON_SERVERSIDE=1;var GET_CONFIG_URL="http://visitor.crm2.qq.com/cgi/visitorcgi/ajax/wpa_first_heart_beat.php";return function(config){var nameAccount=config.nameAccount;if(!nameAccount||nameAccount==="undefined"){return}if(invite.isLoaded(nameAccount)||!filter.TA){return}var uid,cfg,launch=function(uid,cfg){if(!uid||!cfg){return}if(cfg.block===CRM_BLOCK_ON_SERVERSIDE){return}if(browser&&browser.ua){var spiderReg=/spider|bot|^\s*$/;if(spiderReg.test(browser.ua)){return}}if(filter.CRM){cfg.di=config.di;cfg.kfuin=config.kfuin;log(nameAccount+" try launch slave");invite.load(nameAccount,uid,cfg)}};pubSub.one("TA.loaded",function(data){uid=data;launch(uid,cfg)});pubSub.one("Invite.first",function(data){cfg=data;launch(uid,cfg)});ta(nameAccount,domain.topDomain,function(uid){pubSub.pub("TA.loaded",uid)});var opts={nameAccount:nameAccount,dm:domain.topDomain,title:document.title,url:location.href.split("://")[1].split("?")[0]};getJSONP(GET_CONFIG_URL,opts,function(cfg){pubSub.pub("Invite.first",cfg)});config.kfuin&&kfuinCahe.set(nameAccount,config.kfuin)}});