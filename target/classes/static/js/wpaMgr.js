BizQQWPA.define("wpa.wpaMgr","globalSettings,lang.each,util.proxy,util.cookie,util.titleFlash,util.report,util.serialize,util.domain,wpa.WPA",function(require){var globalSettings=require("globalSettings"),each=require("each"),proxy=require("proxy"),titleFlash=require("titleFlash"),report=require("report"),serialize=require("serialize"),domain=require("domain"),cookie=require("cookie"),WPA=require("WPA");var REPORT_POSSIBILITY=40;var getTencentSig=function(){return Math.round((Math.random()||.5)*2147483647)*+new Date%1e10},TENCENT_SIG_NAME="tencentSig",GAP=1e3*60*60*24*365*100;var passRandom=function(poss){var r=poss||10;if(Math.random()*100<=r){return true}return false};var reportWpa=function(url,opts){if(passRandom(REPORT_POSSIBILITY)){report(url+"?"+serialize(opts))}};var displayReport=function(params){var url="http://prom.b.qq.com/wpadisplay/r.gif?",optsArr=["wty","type","nameAccount","kfuin","ws","aty","a","title","wording","wording2"],reportOpts={version:globalSettings.version};each(optsArr,function(){reportOpts[this]=typeof params[this]==="undefined"?"":params[this]});try{var tencentSig=cookie.get(TENCENT_SIG_NAME);if(tencentSig){reportOpts[TENCENT_SIG_NAME]=tencentSig}else{var t=getTencentSig();reportOpts[TENCENT_SIG_NAME]=t;cookie.set(TENCENT_SIG_NAME,t,null,null,GAP)}}catch(e){}report(url+serialize(reportOpts))};return{newWPA:function(params){var nameAccount=params.nameAccount;if(!nameAccount){return}displayReport(params);reportWpa("http://report.b.qq.com/crmReport/accesslog",{FUID:cookie.get("pgv_pvi"),FKFUin:params.kfuin,FNa:params.nameAccount,FRurl:window.document.referrer});return new WPA(params)},invite:function(params,di){var mgr=this,defaultInvite=function(){titleFlash.on("【您有新信息】");params.insert=function(node){var body=document.getElementsByTagName("body")[0];body.insertBefore(node,body.firstChild)};mgr.newWPA(params)};if(!di){defaultInvite();return}try{var chat=proxy({params:params},WPA.prototype.launchChat);window[di]&&window[di](chat,params["msg"])}catch(e){defaultInvite()}}}});