BizQQWPA.define("wpa.WPA","globalSettings,lang.browser,util.cookie,lang.typeEnhance,util.serialize,util.proxy,util.pad,util.Bits,util.getScript,util.getJSONP,util.domain,util.events,util.onLoad,util.offset,util.report,util.log,util.speedReport,wpa.SelectPanel,util.onIframeLoaded,util.GUID,wpa.getQQVersion,wpa.ViewHelper,wpa.views,wpa.ta,wpa.kfuin,wpa.sid",function(require){var globalSettings=require("globalSettings"),proxy=require("proxy"),typeEnhance=require("typeEnhance"),pad=require("pad"),Bits=require("Bits"),getScript=require("getScript"),getJSONP=require("getJSONP"),domain=require("domain"),events=require("events"),onLoad=require("onLoad"),serialize=require("serialize"),browser=require("browser"),offset=require("offset"),report=require("report"),log=require("log"),speedReport=require("speedReport"),GUID=require("GUID"),SelectPanel=require("SelectPanel"),onIframeLoaded=require("onIframeLoaded"),getQQVersion=require("getQQVersion"),ViewHelper=require("ViewHelper"),views=require("views"),ta=require("ta"),kfuinCache=require("kfuin"),cookie=require("cookie"),sidCache=require("sid");var global=window;var WPA_TYPE_TA_INVITE_ONLY="0",WPA_TYPE_NORMAL="1",WPA_TYPE_LINK="2",WPA_TYPE_CUSTOM="3",SESSION_VERSION_TA="4",WPA_STYLE_TYPE_INVITE="20",APPOINTED_TYPE_AUTO="0",APPOINTED_TYPE_KFEXT="1",APPOINTED_TYPE_GROUP="2",WPA_FLOAT_TYPE_FIXED="0",WPA_FLOAT_TYPE_SCROLL="1",WPA_FLOAT_POSITION_X_LEFT="0",WPA_FLOAT_POSITION_X_CENTER="1",WPA_FLOAT_POSITION_X_RIGHT="2",WPA_FLOAT_POSITION_Y_TOP="0",WPA_FLOAT_POSITION_Y_CENTER="1",WPA_FLOAT_POSITION_Y_BOTTOM="2",IS_INVITE_WPA_FALSE="0",IS_INVITE_WPA_TRUE="1",CHAT_TYPE_AIO=1,CHAT_TYPE_ANONYMOUS=2;var SPEED_REPORT_DISPLAY=.1,REPORT_POSSIBILITY=40;var passRandom=function(poss){var r=poss||10;if(Math.random()*100<=r){return true}return false};var reportWpa=function(url,opts){if(passRandom(REPORT_POSSIBILITY)){report(url+"?"+serialize(opts))}};var WPA=function(params){this.params=params;this.insert=params.insert;this.wty=params.wty;var self=this,nameAccount=this.nameAccount=params.nameAccount,kfuin=this.kfuin=params.kfuin;switch(this.wty){case WPA_TYPE_NORMAL:this.render();break;case WPA_TYPE_CUSTOM:this.custom()}!this.kfuin&&kfuinCache.get(nameAccount,function(data){data&&(self.kfuin=data)});!this.sid&&sidCache.get(nameAccount,function(data){data&&(self.sid=data)});report("http://prom.b.qq.com/se/r.gif?na="+nameAccount+"&ref="+encodeURIComponent(document.referrer))};WPA.prototype={render:function(){var params=this.params;var width,height,type=parseInt(params["type"]),typeStr,isFloat=false;switch(type){case 1:typeStr="a01";width=92;height=22;break;case 2:typeStr="a02";width=77;height=22;break;case 10:typeStr="b01";width=93;height=151;isFloat=true;break;case 11:typeStr="b02";width=327;height=172;isFloat=true;break;case 12:typeStr="b03";width=121;height=277;isFloat=true;break;case 20:typeStr="i01";width=327;height=172;isFloat=true;break;case 30:typeStr="d01";width=params["txw"];height=params["txh"];isFloat=true;break}this.type=typeStr;this.width=width;this.height=height;this.createWPA();if(type>9&&type<14||type===20||type===30){this.initFloatWPA()}},createWPA:function(){var speedRpt=speedReport("7818","21","1");var wpa=this,type=this.type,width=this.width,height=this.height,view=views[type];var iframe;try{iframe=document.createElement('<iframe scrolling="no" frameborder="0" width="'+width+'" height="'+height+'" allowtransparency="true" src="about:blank"></iframe>')}catch(e){iframe=document.createElement("iframe");iframe.width=width;iframe.height=height;iframe.setAttribute("scrolling","no");iframe.setAttribute("frameborder",0);iframe.setAttribute("allowtransparency",true);iframe.setAttribute("src","about:blank")}this.node=iframe;this.insert(iframe);if(browser.msie){try{var accessTest=iframe.contentWindow.document}catch(e){iframe.src="javascript:void((function(){document.open();document.domain='"+document.domain+"';document.close()})())"}}var loaded=function(){var iWin=iframe.contentWindow,iDoc=iframe.contentDocument||iWin.document;iDoc.open();iDoc.write(['<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">','<html xmlns="http://www.w3.org/1999/xhtml">',"<head>",'<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />',browser.msie&&iframe.src!=="about:blank"?"<script>document.domain='"+document.domain+"';</script>":"","</head>","<body>",view.templ,"</body>","</html>"].join(""));iDoc.close();var helper=new ViewHelper(iDoc,wpa);view.init(iDoc,helper);var point=1;speedRpt.addPoint(point).send(SPEED_REPORT_DISPLAY)};onIframeLoaded(iframe,loaded)},initFloatWPA:function(){var doc=window.document,params=this.params,type=parseInt(params["type"]),node=this.node,width=this.width,height=this.height;node.style.cssText=["display:none;","position:absolute;",type===20?"z-index:2147483647!important;":"z-index:2147483646!important;"].join(" ");onLoad(initIframeLoad);function initIframeLoad(){var isty=node.style,isIE=browser.msie,ver=parseInt(browser.version,10),isQuirk=doc.compatMode==="BackCompat";isty.position=parseInt(params["fsty"],10)==0?"fixed":"absolute";if(parseInt(params["fposX"])==0){isty.left=8+"px";isty.right="auto";isty.marginLeft=0}else if(parseInt(params["fposX"])==1){isty.left="50%";isty.right="auto";isty.marginLeft="-"+parseInt(width/2)+"px"}else{isty.left="auto";isty.right=8+"px";isty.marginLeft=0}if(parseInt(params["fposY"])==0){isty.top=8+"px";isty.bottom="auto";isty.marginTop=0}else if(parseInt(params["fposY"])==1){isty.top="50%";isty.bottom="auto";isty.marginTop="-"+parseInt(height/2)+"px"}else{isty.top="auto";isty.bottom=8+"px";isty.marginTop=0}if(isIE&ver<7||isQuirk){isty.position="absolute";if(parseInt(params["fsty"])==0){isty.marginTop=0;var itop;if(parseInt(params["fposY"])==0){itop=8}else if(parseInt(params["fposY"])==1){itop=(offset.getClientHeight(doc)-height)/2}else{itop=offset.getClientHeight(doc)-height-8}setInterval(function(){isty.top=offset.getScrollTop(doc)+itop+"px"},128)}}isty.display="block"}},custom:function(){events.addEvent(this.params.node,"click",proxy(this,this.launchChat))},remove:function(){var node=this.node;node.parentNode.removeChild(node)},launchChat:function(callback){var wpa=this,sptReport=speedReport("7818","21","2"),chatType=this.params.chatType;reportWpa("http://report.b.qq.com/crmReport/clicklog",{FUID:cookie.get("pgv_pvi"),FKFUin:wpa.params.kfuin,FNa:wpa.params.nameAccount,FRurl:global.document.referrer});if(browser.isIOS||browser.isAndroid){this.launchMobileChat();return}if(chatType==CHAT_TYPE_ANONYMOUS){wpa.launchAnonymousChat(callback);return}if(chatType==CHAT_TYPE_AIO){wpa.launchAIOChat(callback);return}!browser.msie&&wpa.launchAIOChat(callback);getQQVersion(function(version){sptReport.addPoint(7).send();if(version){browser.msie&&wpa.launchAIOChat(callback);return}new SelectPanel({onAIOChat:function(){wpa.launchAIOChat(callback)},onAnonyChat:function(){wpa.launchAnonymousChat(callback)}})})},launchMobileChat:function(){var nameAccount=this.params.nameAccount;kfuinCache.get(nameAccount,function(kfuin){if(navigator.userAgent.indexOf("MicroMessenger")>-1&&domain.domain.indexOf("qq.com")===-1){location.href="http://wpd.b.qq.com/page/info.php?nameAccount="+nameAccount;return}launch(schema(),fallback);function schema(){var dm=domain.domain,type="crm";if(browser.isQQ&&browser.QQVersion==="4.5"){type="wpa"}return browser.isAndroid&&browser.chrome&&parseInt(browser.version,10)>25?"intent://im/chat?chat_type="+type+"&uin="+kfuin+"&version=1&src_type=web&web_src="+location.protocol+"://"+dm+"#Intent;scheme=mqqwpa;action=android.intent.action.VIEW;end":"mqqwpa://im/chat?chat_type="+type+"&uin="+kfuin+"&version=1&src_type=web&web_src="+location.protocol+"://"+dm}function launch(schema,fail){var start=+new Date;location.href=schema;setTimeout(function(){var gap=+new Date-start;if(gap<1e3){fail&&fail()}},800)}function fallback(){location.href="http://wpd.b.qq.com/page/info.php?nameAccount="+nameAccount}})},launchAIOChat:function(){var iframe=document.createElement("iframe"),body=document.getElementsByTagName("body")[0];iframe.style.display="none";body.insertBefore(iframe,body.firstChild);return function(callback){var params=this.params,kfuin=this.kfuin,opts={na:params.nameAccount,kfuin:kfuin,aty:params.aty,a:params.a,sid:this.sid,uid:ta.uid,url:domain.url,title:document.title,dm:domain.topDomain,clkSrc:params.clkSrc||"",ext:params.ext||""},guid=GUID();var sptReport=speedReport("7818","21","2");getJSONP("http://wpd.b.qq.com/cgi/get_sign.php",opts,function(rs){if(!rs||rs.r!==0||!rs.data){return}iframe.src=rs.data.sign;var isLoaded=false,loaded=function(){if(isLoaded){return}isLoaded=true;var clickId=rs.data.clkID;sptReport.addPoint(5).send();report("http://promreport.crm2.qq.com/wpaclick/r.gif?ty=1&kfuin="+kfuin+"&version="+globalSettings.version+"&browser="+encodeURIComponent(navigator.userAgent)+"&bfrom=1&appointType="+params.aty+"&appoint="+params.a+"&clkID="+clickId+"&guid="+guid);global.taClick&&global.taClick(clickId,"clickid");typeEnhance.isFunction(callback)&&setTimeout(function(){callback(params)},1e3)};onIframeLoaded(iframe,loaded);if(browser.msie){var fallback=function(){setTimeout(function(){if(isLoaded){return}/interactive/.test(iframe.readyState)?loaded():fallback()},500)};fallback()}});report("http://promreport.crm2.qq.com/wpaclickorg/r.gif?kfuin="+kfuin+"&version="+globalSettings.version+"&browser="+encodeURIComponent(navigator.userAgent)+"&bfrom=1&appointType="+params.aty+"&appoint="+params.a+"&guid="+guid)}}(),launchAnonymousChat:function(callback){var params=this.params,sptReport=speedReport("7818","21","2"),url="http://wpd.b.qq.com/page/webchat.html?nameAccount="+this.nameAccount,opener=window.open(url,"_blank","height=516, width=598,toolbar=no,scrollbars=no,menubar=no,status=no,location=no");typeEnhance.isFunction(callback)&&callback(params);report("http://promreport.crm2.qq.com/wpaclick/r.gif?ty=2&kfuin="+this.kfuin+"&version="+globalSettings.version+"&browser="+encodeURIComponent(navigator.userAgent)+"&bfrom=1&appointType="+params.aty+"&appoint="+params.a);opener.onload=function(){sptReport.addPoint(6).send()}}};return WPA});